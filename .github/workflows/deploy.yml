name: uCss Build & Deploy

on:
  push:
    branches: [ "main" ] # Runs on every edit
  release:
    types: [published]   # Runs when you tag a release (v1.0)

jobs:
  build-and-deploy:
    name: üöÄ Build uCss
    runs-on: ubuntu-latest
    steps:
      # 1. Get your code from GitHub
      - name: üöö Checkout Code
        uses: actions/checkout@v4

      # 2. The Build Process (3 Files Generated)
      - name: üèóÔ∏è Build & Optimize
        run: |
          # Create the output folders
          mkdir -p dist/lib

          # --- FILE 1: Full Readable Source (u.css) ---
          cat src/css/clear.css \
              src/css/s.css \
              src/css/set.css \
              src/css/t.css \
              src/css/tx.css \
              src/css/ta.css \
              src/css/med.css \
              src/css/o.css \
              src/css/m.css \
              src/css/p.css \
              src/css/rad.css \
              src/css/lnk.css \
              src/css/crd.css \
              src/css/btn.css \
              src/css/f.css \
              src/css/g.css > dist/u.css

          # --- FILE 2: root.css (Standalone) ---
          # Copied to dist/lib/root.css so it uploads to /latest/lib/root.css
          cp src/css/root.css dist/lib/root.css
          
          # Minify root.css -> root.min.css
          npx -y esbuild src/css/root.css --minify --outfile=dist/lib/root.min.css
          
          # Gzip root.min.css -> root.min.css.gz
          gzip -9 -k dist/lib/root.min.css

          # --- FILE 3: Minified (u.min.css) ---
          # Use esbuild for proper minification
          npx -y esbuild dist/u.css --minify --outfile=dist/u.min.css

          # --- FILE 4: Gzipped (u.min.css.gz) ---
          gzip -9 -k dist/u.min.css

      # 3. Determine Server Folder
      - name: üìÇ Set Server Path
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "dir=${{ github.ref_name }}/" >> $GITHUB_OUTPUT
          else
            echo "dir=latest/" >> $GITHUB_OUTPUT
          fi

      # 4. Upload to Server
      - name: ‚òÅÔ∏è Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: "${{ secrets.FTP_SERVER }}"
          username: "${{ secrets.FTP_USERNAME }}"
          password: "${{ secrets.FTP_PASSWORD }}"
          local-dir: ./dist/      # Uploads the entire 'dist' folder (all 3 files)
          server-dir: ./${{ steps.target.outputs.dir }}