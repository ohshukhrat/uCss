name: uCss Build & Deploy

on:
  push:
    branches: [ "main", "dev" ] # Runs on updates to main and dev
  release:
    types: [published]   # Runs when you tag a release (v1.0)

jobs:
  build-and-deploy:
    name: ğŸš€ Build uCss
    runs-on: ubuntu-latest
    steps:
      # 1. Get your code from GitHub
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      # Determine Server Folder logic (MOVED EARLIER)
      - name: ğŸ“‚ Set Server Path
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "build_arg=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            # Release: Upload everything
            echo "local_dir=./dist/" >> $GITHUB_OUTPUT
            echo "server_dir=./" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "build_arg=stable" >> $GITHUB_OUTPUT
            # Main: Upload Root (index.html) + Stable folder
            echo "local_dir=./dist/" >> $GITHUB_OUTPUT
            echo "server_dir=./" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "build_arg=latest" >> $GITHUB_OUTPUT
            # Dev: Upload ONLY latest folder (Protect production index.html)
            # We assume build.sh creates dist/latest/. We upload just that content to /latest/
            echo "local_dir=./dist/latest/" >> $GITHUB_OUTPUT
            echo "server_dir=./latest/" >> $GITHUB_OUTPUT
          else
             TIMESTAMP=$(date +"%Y-%m-%d-%H-%M")
            echo "build_arg=preview/$TIMESTAMP" >> $GITHUB_OUTPUT
            echo "local_dir=./dist/" >> $GITHUB_OUTPUT
            echo "server_dir=./preview/$TIMESTAMP/" >> $GITHUB_OUTPUT
          fi

      - name: â¬¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install dependencies (marked package for render-docs.js)
      - name: ğŸ“¦ Install Dependencies
        run: npm install



      # 2. The Build Process (3 Files Generated)
      - name: ğŸ—ï¸ Build & Optimize
        run: |
          # Run the build script with target arg
          chmod +x build.sh
          ./build.sh "${{ steps.target.outputs.build_arg }}"

      # 4. Upload to Server
      - name: â˜ï¸ Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: "${{ secrets.FTP_SERVER }}"
          username: "${{ secrets.FTP_USERNAME }}"
          password: "${{ secrets.FTP_PASSWORD }}"
          local-dir: "${{ steps.target.outputs.local_dir }}"
          server-dir: "${{ steps.target.outputs.server_dir }}"