name: uCss Build & Deploy

on:
  push:
    branches: [ "main" ] # Runs on every edit
  release:
    types: [published]   # Runs when you tag a release (v1.0)

jobs:
  build-and-deploy:
    name: üöÄ Build uCss
    runs-on: ubuntu-latest
    steps:
      # 1. Get your code from GitHub
      - name: üöö Checkout Code
        uses: actions/checkout@v4

      # 2. The Build Process (3 Files Generated)
      - name: üèóÔ∏è Build & Optimize
        run: |
          # Create the output folder
          mkdir -p dist

          # --- FILE 1: Full Readable Source (u.css) ---
          # We combine all files in the specific order requested.
          # var.css is EXCLUDED from the build but tracked in git.
          cat src/css/clear.css \
              src/css/s.css \
              src/css/set.css \
              src/css/t.css \
              src/css/tx.css \
              src/css/ta.css \
              src/css/med.css \
              src/css/o.css \
              src/css/lnk.css \
              src/css/crd.css \
              src/css/btn.css \
              src/css/f.css \
              src/css/g.css > dist/u.css

          # --- PREP: Install Lightning CSS ---
          # Using lightningcss-cli because it correctly handles 
          # modern nesting (&) and @container queries.
          npm install -g lightningcss-cli

          # --- FILE 2: Minified (u.min.css) ---
          # --minify: Removes spaces/comments
          # --targets: ">= 0.25%" ensures it converts modern nesting 
          # into standard CSS so it doesn't break older browsers.
          lightningcss --minify --bundle --targets ">= 0.25%" dist/u.css -o dist/u.min.css

          # --- FILE 3: Gzipped (u.min.css.gz) ---
          # -9: Max compression
          # -k: Keep the original file (don't delete u.min.css)
          gzip -9 -k dist/u.min.css

      # 3. Determine Server Folder
      - name: üìÇ Set Server Path
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "dir=${{ github.ref_name }}/" >> $GITHUB_OUTPUT
          else
            echo "dir=latest/" >> $GITHUB_OUTPUT
          fi

      # 4. Upload to Server
      - name: ‚òÅÔ∏è Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: "${{ secrets.FTP_SERVER }}"
          username: "${{ secrets.FTP_USERNAME }}"
          password: "${{ secrets.FTP_PASSWORD }}"
          local-dir: ./dist/      # Uploads the entire 'dist' folder (all 3 files)
          server-dir: ./${{ steps.target.outputs.dir }}