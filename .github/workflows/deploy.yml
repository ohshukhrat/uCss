name: uCss Build & Deploy

on:
  push:
    branches: [ "**" ] # Runs on updates to all branches
  release:
    types: [published]   # Runs when you tag a release (v1.0)

jobs:
  build-and-deploy:
    name: üöÄ Build uCss
    runs-on: ubuntu-latest
    steps:
      # 1. Get your code from GitHub
      - name: üöö Checkout Code
        uses: actions/checkout@v4

      # Determine Server Folder logic (MOVED EARLIER)
      - name: üìÇ Set Server Path
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "build_arg=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            # Release: Upload everything
            echo "local_dir=./dist/" >> $GITHUB_OUTPUT
            echo "server_dir=./" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "build_arg=stable" >> $GITHUB_OUTPUT
            # Main: Upload Root (index.html) + Stable folder
            echo "local_dir=./dist/" >> $GITHUB_OUTPUT
            echo "server_dir=./" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "build_arg=latest" >> $GITHUB_OUTPUT
            # Dev: Upload ONLY latest folder (Protect production index.html)
            # We assume build.sh creates dist/latest/. We upload just that content to /latest/
            echo "local_dir=./dist/latest/" >> $GITHUB_OUTPUT
            echo "server_dir=./latest/" >> $GITHUB_OUTPUT
          else
             # Use seconds for consistency with build.js
             TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
            echo "build_arg=preview-$TIMESTAMP" >> $GITHUB_OUTPUT
            echo "local_dir=./dist/preview-$TIMESTAMP/" >> $GITHUB_OUTPUT
            echo "server_dir=./preview-$TIMESTAMP/" >> $GITHUB_OUTPUT
          fi

      - name: ‚¨¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ‚ôªÔ∏è Cache Node Modules
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: üì¶ Install Dependencies
        run: npm ci



      # 2. The Build Process (3 Files Generated)
      - name: üèóÔ∏è Build & Optimize
        run: |
          # Run the build script with target arg
          node scripts/build.js "${{ steps.target.outputs.build_arg }}"

          # If main branch (stable), also build prefixed versions (dist/p, dist/v)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            node scripts/build.js p
            node scripts/build.js v
          fi

      # 3. Cleanup Old Previews (Remote)
      - name: üßπ Cleanup Old Previews
        run: node scripts/cleanup-remote.js
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}

      # 4. Upload to Server
      - name: ‚òÅÔ∏è Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: "${{ secrets.FTP_SERVER }}"
          username: "${{ secrets.FTP_USERNAME }}"
          password: "${{ secrets.FTP_PASSWORD }}"
          local-dir: "${{ steps.target.outputs.local_dir }}"
          server-dir: "${{ steps.target.outputs.server_dir }}"